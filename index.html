<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>定投策略</title>
<style>
:root{
  --primary:#6178ff;
  --primary-dark:#4a5fd0;
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#333;
  --radius:14px;
  --shadow:0 4px 20px rgba(0,0,0,.08);
}

*{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
}
html,body{
  margin:0;
  padding:0;
  height:100%;
  font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ===== 玻璃罩 ===== */
.glass-container{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:40px 20px;
}
.glass-container .glass{
  width:100%;
  max-width:480px;
  background:rgba(255,255,255,.75);
  backdrop-filter:blur(10px);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:32px;
}
.glass-container header{
  text-align:center;
  font-size:24px;
  font-weight:700;
  color:var(--primary);
  margin-bottom:20px;
}
.glass-container .input-card{
  margin-bottom:16px;
}
.glass-container label{
  font-size:14px;
  color:#666;
  margin-bottom:6px;
}
.glass-container input{
  width:100%;
  border:1px solid #e0e0e0;
  border-radius:8px;
  padding:12px;
  font-size:16px;
}
.glass-container .result-card{
  background:linear-gradient(135deg,#e0e7ff 0%,#c7d2ff 100%);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:20px;
  display:none;
  animation:fadeIn .3s ease;
}
.glass-container .result-card p{
  margin:6px 0;
  font-size:16px;
}
.glass-container .result-card .val{
  font-size:24px;
  font-weight:700;
  color:var(--primary);
}
.glass-container button{
  width:100%;
  border:none;
  border-radius:var(--radius);
  padding:14px;
  font-size:16px;
  font-weight:700;
  color:#fff;
  background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
  box-shadow:var(--shadow);
  cursor:pointer;
}
button:active{
  transform:scale(.98);
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(6px);}
  to{opacity:1;transform:none;}
}
</style>
</head>
<body class="glass-container">
<div class="glass">
  <header>移动平均持仓成本策略</header>

  <div class="input-card">
    <label>定投基准金额（元）</label>
    <input id="base" type="number" step="0.01" value="1000" />
  </div>
  <div class="input-card">
    <label>当前基金净值（元）</label>
    <input id="nav" type="number" step="0.0001" value="" placeholder="请输入当前净值" />
  </div>
  <div class="input-card">
    <label>平均持仓成本（元）</label>
    <input id="avg" type="number" step="0.0001" value="" placeholder="请输入持仓成本" />
  </div>

  <div id="res" class="result-card">
    <p>扣款比例：<span class="val" id="ratio"></span></p>
    <p>本期金额：<span class="val" id="amt"></span> 元</p>
  </div>

  <button onclick="calc()">计算本期应投金额</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/decimal.js@10.4.3/decimal.min.js"></script>
<script>
function calc() {
  // 获取输入值并直接用decimal.js处理，避免转换为float
  const baseValue = new Decimal(document.getElementById('base').value || 0);
  const navValue = new Decimal(document.getElementById('nav').value || 0);
  const avgValue = new Decimal(document.getElementById('avg').value || 0);
  
  // 检查输入是否有效
  if (baseValue.isNaN() || navValue.isNaN() || avgValue.isNaN()) { 
    alert('请检查输入'); 
    return; 
  }
  
  // 检查关键参数是否为0，避免除零错误
  if (avgValue.isZero()) {
    alert('平均持仓成本不能为0'); 
    return; 
  }

  // 使用decimal.js进行精确计算
  const d = navValue.minus(avgValue).div(avgValue);

  let r = new Decimal(1);
  if (d.lte(-0.25))       r = new Decimal(2.00);
  else if (d.lte(-0.20))   r = new Decimal(1.95);
  else if (d.lte(-0.15))   r = new Decimal(1.90);
  else if (d.lte(-0.10))   r = new Decimal(1.80);
  else if (d.lte(-0.075))  r = new Decimal(1.60);
  else if (d.lte(-0.05))   r = new Decimal(1.40);
  else if (d.lte(-0.025))  r = new Decimal(1.20);
  else if (d.lt(0.025))    r = new Decimal(1.00);
  else if (d.lt(0.05))     r = new Decimal(0.90);
  else if (d.lt(0.075))    r = new Decimal(0.80);
  else if (d.lt(0.10))     r = new Decimal(0.70);
  else if (d.lt(0.15))     r = new Decimal(0.60);
  else if (d.lt(0.20))     r = new Decimal(0.55);
  else if (d.lt(0.25))     r = new Decimal(0.525);
  else                     r = new Decimal(0.50);
  
  // 使用decimal.js进行最终结果计算并转换为字符串显示
  const ratioDisplay = r.times(100).toFixed(1) + '%';
  const amtDisplay = baseValue.times(r).toFixed(2);
  
  document.getElementById('ratio').textContent = ratioDisplay;
  document.getElementById('amt').textContent = amtDisplay;
  document.getElementById('res').style.display = 'block';
}
</script>
</body>
</html>
